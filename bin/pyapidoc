#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""Dead simple API documentation generation tool

Usage:
    pyapidoc [options] <module>

Options:
    -h, --help
    -d, --debug
    -t TPL, --template TPL
    -o OUT, --output OUT
"""

import os
import sys
import logging
import inspect
import jinja2
from docopt import docopt


log = logging.getLogger('simpledoc')


def main():
    """Main function of the pyapidoc"""

    sys.path = [os.getcwd()] + sys.path
    log.debug('pwd: %s', os.getcwd())
    log.debug('path: %s', str(sys.path))

    try:
        mod = __import__(opt['<module>'])
    except Exception:
        log.error('Unable to import module %s', opt['<module>'])
        return

    out = dict()
    out['name'] = opt['<module>']
    out['doc'] = inspect.getdoc(mod)
    out['classes'] = get_classes(mod)
    out['functions'] = get_functions(mod)

    with open(opt['--template']) as f:
        template = jinja2.Template(f.read())

    parts = opt['--template'].split('.')
    ext = parts[-2]

    with open(os.path.join(opt['--output'], opt['<module>'] + '.' + ext), 'w') as f:
        f.write(template.render(module=out, trim_blocks=True, lstrip_block=True))


def get_classes(obj: object) -> list:
    """Get lisf ot classes of the given object, each class is represented
    by dictionary with fields: name, doc and functions, where function is 
    list of functions given by get_function
    """
    out = list()
    for cl in inspect.getmembers(obj, inspect.isclass):
        if cl[0] != "__class__" and not cl[0].startswith("_"):
            log.debug('Class: %s file: %s', cl[0], inspect.getfile(cl[1]))
            outcl = dict()
            outcl['name'] = cl[0]
            outcl['doc'] = inspect.getdoc(cl[1])
            outcl['functions'] = get_functions(cl[1])
            out.append(outcl)

    return out


def get_functions(obj: object) -> list:
    """Get list of function of given object, each function is represented
    by dictionary with fields: name, signature and doc. 
    """
    out = list()
    for fce in inspect.getmembers(obj, inspect.isfunction):

        outfce = dict()
        outfce['name'] = fce[0]
        outfce['signature'] = str(inspect.signature(fce[1]))
        outfce['doc'] = inspect.getdoc(fce[1])

        out.append(outfce)
    return out


if __name__ == "__main__":
    opt = docopt(__doc__)
    logging.basicConfig(level='DEBUG' if opt['--debug'] else 'INFO')
    main()


